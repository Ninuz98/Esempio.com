<!DOCTYPE html>
<html lang="it" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Prenotazioni Casa Vacanze</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            user-select: none;
            -webkit-user-select: none; /* For Safari */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
        }
        .day-cell {
            transition: all 0.1s ease-in-out;
            border-radius: 0.75rem; /* Forma rettangolare con angoli arrotondati */
            position: relative;
            min-height: 5rem; /* Altezza ottimizzata per mobile */
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 0.25rem;
        }
        @media (min-width: 640px) {
            .day-cell {
                min-height: 7rem;
                padding: 0.5rem;
            }
        }
        .day-cell:hover:not(.occupied-range):not(.selection-preview) {
            background-color: #f3f4f6; /* gray-100 */
        }
        .occupied-range {
            background-color: #f3f4f6; /* gray-100 */
            cursor: pointer;
        }
        .intermediate-day {
            cursor: not-allowed !important;
        }
        .check-in {
            background-color: #86efac !important; /* green-300, più acceso */
        }
        .check-out {
            background-color: #fca5a5 !important; /* red-300, più acceso */
        }
        .changeover-day {
            background: linear-gradient(to bottom right, #fca5a5 49.5%, #86efac 50.5%) !important;
        }
        .guest-info, .guest-info div, .guest-info .time-info, .occupied-range .font-semibold {
             color: black !important; /* Testo nero per leggibilità */
        }
        .guest-info {
            font-weight: 600;
            font-size: 0.65rem;
            line-height: 1.1;
        }
        @media (min-width: 640px) {
            .guest-info {
                font-size: 0.75rem;
                line-height: 1.2;
            }
        }
        .time-info {
            font-size: 0.6rem;
            opacity: 0.9;
        }
        @media (min-width: 640px) {
            .time-info {
                font-size: 0.7rem;
            }
        }
        .line-connector {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #f3f4f6; /* gray-100 */
            z-index: -1;
        }
        .line-start .line-connector { left: 50%; }
        .line-end .line-connector { right: 50%; }
        .line-single .line-connector { display: none; }
        
        .selection-preview {
            background-color: #bfdbfe !important; /* blue-200 */
        }
        .selection-preview .line-connector {
             background-color: #bfdbfe; /* blue-200 */
        }
    </style>
</head>
<body class="bg-white text-black p-2 sm:p-6 md:p-8">

    <div class="max-w-5xl mx-auto bg-white border border-gray-200 rounded-2xl shadow-lg p-4 sm:p-6 relative">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-200 pb-6">
            <div class="text-center md:text-left">
                <h1 class="text-2xl sm:text-3xl font-bold text-black">Calendario Prenotazioni</h1>
                <p class="text-gray-600 mt-1 text-sm sm:text-base">Clicca e trascina sui giorni liberi per creare una prenotazione.</p>
            </div>
        </div>

        <div class="flex items-center justify-between mb-4">
            <button id="prev-month" class="px-3 py-2 sm:px-4 bg-gray-100 text-black rounded-lg hover:bg-gray-200 transition-colors">&lt;</button>
            <h2 id="month-year" class="text-xl sm:text-2xl font-semibold text-center w-full text-black"></h2>
            <button id="next-month" class="px-3 py-2 sm:px-4 bg-gray-100 text-black rounded-lg hover:bg-gray-200 transition-colors">&gt;</button>
        </div>

        <div id="delete-section" class="mb-6 p-4 bg-white border-y border-gray-200 flex flex-col sm:flex-row items-center gap-3">
            <select id="guest-list-dropdown" class="flex-grow w-full sm:w-auto bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-black focus:ring-2 focus:ring-blue-500">
                <option value="">Seleziona un ospite per cancellare...</option>
            </select>
            <button id="delete-selected-booking" disabled class="w-full sm:w-auto bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors shadow-sm disabled:bg-gray-300 disabled:cursor-not-allowed">
                Cancella Prenotazione
            </button>
        </div>

        <div id="calendar-grid" class="grid grid-cols-7 gap-x-1 sm:gap-x-2 gap-y-1">
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Lun</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Mar</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Mer</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Gio</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Ven</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Sab</div>
            <div class="text-center font-medium text-gray-500 py-2 text-sm">Dom</div>
        </div>
    </div>

    <!-- Modali -->
    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md transform transition-all border border-gray-200">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-black">Crea Nuova Prenotazione</h3>
            <div class="mb-4 text-center bg-gray-100 p-3 rounded-lg text-black">
                <p><span class="font-semibold">Check-in:</span> <span id="modal-check-in-date"></span></p>
                <p><span class="font-semibold">Check-out:</span> <span id="modal-check-out-date"></span></p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="guest-name" class="block text-sm font-medium text-gray-700 mb-1">Nome Ospite</label>
                    <input type="text" id="guest-name" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-black" placeholder="Es. Mario Rossi">
                </div>
                <div class="flex gap-4">
                     <div class="w-1/2">
                        <label for="check-in-time" class="block text-sm font-medium text-gray-700 mb-1">Orario Check-in</label>
                        <input type="time" id="check-in-time" value="14:00" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-black">
                    </div>
                     <div class="w-1/2">
                        <label for="check-out-time" class="block text-sm font-medium text-gray-700 mb-1">Orario Check-out</label>
                        <input type="time" id="check-out-time" value="11:00" class="w-full px-3 py-2 border border-gray-300 bg-white rounded-lg text-black">
                    </div>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button id="save-booking" class="w-full bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-semibold">Salva</button>
                <button id="cancel-booking" class="w-full bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 font-semibold">Annulla</button>
            </div>
        </div>
    </div>
    <div id="details-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md border border-gray-200">
            <h3 class="text-2xl font-bold mb-4 text-black">Dettagli Prenotazione</h3>
            <div id="details-content" class="space-y-3 text-gray-700">
                <!-- I dettagli verranno inseriti qui da JS -->
            </div>
            <div class="flex gap-3 mt-6">
                <button id="edit-booking" class="w-full bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 font-semibold">Modifica</button>
                <button id="close-details-modal" class="w-full bg-gray-200 text-gray-800 px-4 py-3 rounded-lg hover:bg-gray-300 font-semibold">Chiudi</button>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-sm text-center border border-gray-200">
            <h3 class="text-xl font-bold mb-4 text-black">Conferma Cancellazione</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex gap-4">
                <button id="confirm-delete-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 font-semibold">Conferma</button>
                <button id="cancel-delete-btn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 font-semibold">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        let bookings = {}; 
        let guestBookings = new Map();

        const monthYearEl = document.getElementById('month-year');
        const calendarGridEl = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month');
        const nextMonthBtn = document.getElementById('next-month');

        let currentDate = new Date();
        currentDate.setDate(1); 

        const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
        
        let isSelecting = false;
        let selectionStartDate = null;
        let selectionEndDate = null;

        function generateCalendar(year, month) {
            monthYearEl.textContent = `${monthNames[month]} ${year}`;
            
            const dayCells = calendarGridEl.querySelectorAll('.day-cell, .empty-cell');
            dayCells.forEach(cell => cell.remove());

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            
            const emptyDays = (firstDayOfMonth.getDay() + 6) % 7;

            for (let i = 0; i < emptyDays; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'empty-cell rounded-lg aspect-ratio-1/1';
                calendarGridEl.appendChild(emptyCell);
            }

            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const dayCell = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                dayCell.className = 'day-cell cursor-pointer bg-white';
                dayCell.dataset.date = dateStr;

                const dayNumber = document.createElement('span');
                dayNumber.className = 'font-semibold text-black text-sm absolute top-2 right-3';
                dayNumber.textContent = i;
                
                const guestInfo = document.createElement('div');
                guestInfo.className = 'guest-info text-xs text-center break-words space-y-1';

                dayCell.append(dayNumber, guestInfo);
                dayCell.addEventListener('click', () => handleDayClick(dateStr));
                calendarGridEl.appendChild(dayCell);
            }
            updateCalendarUI();
        }
        
        function updateCalendarUI() {
            guestBookings.clear();
            const tempBookings = {};

            for (const dateStr in bookings) {
                if (!bookings[dateStr]) continue;
                bookings[dateStr].forEach(event => {
                    if (event.eventType === 'checkin') {
                        tempBookings[event.bookingId] = { ...event, start: dateStr };
                    }
                });
            }

            for (const dateStr in bookings) {
                 if (!bookings[dateStr]) continue;
                bookings[dateStr].forEach(event => {
                    if (event.eventType === 'checkout' && tempBookings[event.bookingId]) {
                        const checkinEvent = tempBookings[event.bookingId];
                        const start = new Date(Date.UTC(...checkinEvent.start.split('-').map((n,i) => i === 1 ? n-1 : n)));
                        const end = new Date(Date.UTC(...dateStr.split('-').map((n,i) => i === 1 ? n-1 : n)));
                        const currentRange = [];
                        for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
                            currentRange.push(d.toISOString().split('T')[0]);
                        }
                        guestBookings.set(event.bookingId, {
                            start: checkinEvent.start,
                            end: dateStr,
                            guestName: event.guestName,
                            days: currentRange
                        });
                        delete tempBookings[event.bookingId];
                    }
                });
            }
            
            document.querySelectorAll('.day-cell').forEach(cell => {
                const dateStr = cell.dataset.date;
                
                const guestInfoEl = cell.querySelector('.guest-info');
                const dayNumberEl = cell.querySelector('span');
                cell.className = 'day-cell cursor-pointer bg-white'; 
                guestInfoEl.innerHTML = '';
                cell.dataset.bookingIds = '';
                const existingConnector = cell.querySelector('.line-connector');
                if(existingConnector) existingConnector.remove();

                let bookingsForThisDay = bookings[dateStr] || [];
                let bookingIdsForThisDay = bookingsForThisDay.map(b => b.bookingId);
                cell.dataset.bookingIds = JSON.stringify(bookingIdsForThisDay);

                let isIntermediate = false;
                for (const booking of guestBookings.values()) {
                    if (booking.days.includes(dateStr) && booking.start !== dateStr && booking.end !== dateStr) {
                        isIntermediate = true;
                        break;
                    }
                }

                if (isIntermediate) {
                    cell.classList.add('occupied-range', 'intermediate-day');
                    dayNumberEl.className = 'font-semibold text-gray-400 text-sm absolute top-2 right-3';
                }

                if (bookingsForThisDay.length > 0) {
                    if (!isIntermediate) cell.classList.add('occupied-range');
                    
                    const hasCheckin = bookingsForThisDay.some(b => b.eventType === 'checkin');
                    const hasCheckout = bookingsForThisDay.some(b => b.eventType === 'checkout');
                    
                    if (hasCheckin && hasCheckout) {
                        cell.classList.add('changeover-day');
                        dayNumberEl.className = 'font-semibold text-black text-sm absolute top-2 right-3';
                        const checkin = bookingsForThisDay.find(b => b.eventType === 'checkin');
                        const checkout = bookingsForThisDay.find(b => b.eventType === 'checkout');
                        guestInfoEl.innerHTML = `
                            <div class="text-xs leading-tight text-black"><i class="fa-solid fa-arrow-right-from-bracket text-xs opacity-80"></i> ${checkout.guestName} (${checkout.time})</div>
                            <div class="text-xs leading-tight text-black"><i class="fa-solid fa-arrow-right-to-bracket text-xs opacity-80"></i> ${checkin.guestName} (${checkin.time})</div>
                        `;
                    } else if (hasCheckin) {
                        cell.classList.add('check-in');
                        dayNumberEl.className = 'font-semibold text-black text-sm absolute top-2 right-3';
                        const checkin = bookingsForThisDay.find(b => b.eventType === 'checkin');
                        guestInfoEl.innerHTML = `<div class="font-semibold">${checkin.guestName}</div><div class="time-info">${checkin.time}</div>`;
                    } else if (hasCheckout) {
                        cell.classList.add('check-out');
                        dayNumberEl.className = 'font-semibold text-black text-sm absolute top-2 right-3';
                        const checkout = bookingsForThisDay.find(b => b.eventType === 'checkout');
                        guestInfoEl.innerHTML = `<div class="font-semibold">${checkout.guestName}</div><div class="time-info">${checkout.time}</div>`;
                    }
                }

                for (const booking of guestBookings.values()) {
                    if (booking.days.includes(dateStr)) {
                        if (booking.start !== booking.end) {
                            if (dateStr === booking.start) cell.classList.add('line-start');
                            else if (dateStr === booking.end) cell.classList.add('line-end');
                            else cell.classList.add('line-middle');
                            const connector = document.createElement('div');
                            connector.className = 'line-connector';
                            if (!cell.querySelector('.line-connector')) cell.appendChild(connector);
                        } else {
                            cell.classList.add('line-single');
                        }
                    }
                }
            });

            const guestDropdown = document.getElementById('guest-list-dropdown');
            const deleteSelectedBtn = document.getElementById('delete-selected-booking');
            const currentSelection = guestDropdown.value;
            guestDropdown.innerHTML = '<option value="">Seleziona un ospite per cancellare...</option>';
            [...guestBookings.entries()].sort((a,b) => new Date(a[1].start) - new Date(b[1].start)).forEach(([bookingId, bookingInfo]) => {
                const option = document.createElement('option');
                option.value = bookingId;
                option.textContent = `${bookingInfo.guestName} (${bookingInfo.start} - ${bookingInfo.end})`;
                guestDropdown.appendChild(option);
            });
            guestDropdown.value = currentSelection;
            deleteSelectedBtn.disabled = guestDropdown.value === '';
        }
        
        const bookingModal = document.getElementById('booking-modal');
        const detailsModal = document.getElementById('details-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const guestNameInput = document.getElementById('guest-name');
        const checkInTimeInput = document.getElementById('check-in-time');
        const checkOutTimeInput = document.getElementById('check-out-time');
        const saveBtn = document.getElementById('save-booking');
        const cancelBtn = document.getElementById('cancel-booking');
        const modalCheckInDateEl = document.getElementById('modal-check-in-date');
        const modalCheckOutDateEl = document.getElementById('modal-check-out-date');

        function capitalizeName(name) {
            return name.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function openBookingModal(checkIn, checkOut, bookingIdToEdit = null) {
            document.getElementById('modal-title').textContent = bookingIdToEdit ? 'Modifica Prenotazione' : 'Crea Nuova Prenotazione';
            modalCheckInDateEl.textContent = checkIn;
            modalCheckOutDateEl.textContent = checkOut;
            
            if (bookingIdToEdit) {
                const bookingInfo = guestBookings.get(bookingIdToEdit);
                const startBooking = (bookings[bookingInfo.start] || []).find(b => b.bookingId === bookingIdToEdit);
                const endBooking = (bookings[bookingInfo.end] || []).find(b => b.bookingId === bookingIdToEdit);
                guestNameInput.value = startBooking.guestName || '';
                checkInTimeInput.value = startBooking.time || '14:00';
                checkOutTimeInput.value = endBooking.time || '11:00';
                saveBtn.onclick = () => saveExistingBooking(bookingIdToEdit, checkIn, checkOut);
            } else {
                guestNameInput.value = '';
                checkInTimeInput.value = '14:00';
                checkOutTimeInput.value = '11:00';
                saveBtn.onclick = () => saveNewBooking(checkIn, checkOut);
            }
            bookingModal.classList.remove('hidden');
        }

        function closeBookingModal() { bookingModal.classList.add('hidden'); }
        
        function openDetailsModal(bookingIds) {
            const detailsContent = document.getElementById('details-content');
            detailsContent.innerHTML = '';
            bookingIds.forEach(id => {
                const bookingInfo = guestBookings.get(id);
                if (bookingInfo) {
                    const startBooking = (bookings[bookingInfo.start] || []).find(b => b.bookingId === id);
                    const endBooking = (bookings[bookingInfo.end] || []).find(b => b.bookingId === id);
                    const detailBlock = document.createElement('div');
                    detailBlock.className = 'p-3 border-t border-gray-200 first:border-t-0';
                    detailBlock.innerHTML = `
                        <p><span class="font-semibold w-24 inline-block">Ospite:</span> <span>${startBooking?.guestName || 'N/D'}</span></p>
                        <p><span class="font-semibold w-24 inline-block">Check-in:</span> <span>${bookingInfo.start} ore ${startBooking?.time || ''}</span></p>
                        <p><span class="font-semibold w-24 inline-block">Check-out:</span> <span>${bookingInfo.end} ore ${endBooking?.time || ''}</span></p>
                    `;
                    detailsContent.appendChild(detailBlock);
                }
            });
            document.getElementById('edit-booking').onclick = () => {
                closeDetailsModal();
                openBookingModal(guestBookings.get(bookingIds[0]).start, guestBookings.get(bookingIds[0]).end, bookingIds[0]);
            };
            document.getElementById('edit-booking').style.display = bookingIds.length === 1 ? 'block' : 'none';
            detailsModal.classList.remove('hidden');
        }
        
        function closeDetailsModal() { detailsModal.classList.add('hidden'); }

        function openConfirmModal(message, onConfirm) {
            document.getElementById('confirm-message').textContent = message;
            confirmModal.classList.remove('hidden');
            document.getElementById('confirm-delete-btn').onclick = () => { onConfirm(); closeConfirmModal(); };
        }

        function closeConfirmModal() { confirmModal.classList.add('hidden'); }

        document.getElementById('close-details-modal').addEventListener('click', closeDetailsModal);
        document.getElementById('cancel-delete-btn').addEventListener('click', closeConfirmModal);

        function saveBookingsToLocalStorage() {
            localStorage.setItem('calendarAppBookings', JSON.stringify(bookings));
        }

        function loadBookingsFromLocalStorage() {
            const savedBookings = localStorage.getItem('calendarAppBookings');
            bookings = savedBookings ? JSON.parse(savedBookings) : {};
        }

        function saveNewBooking(startDate, endDate) {
            const guestNameRaw = guestNameInput.value.trim();
            if (!guestNameRaw) { alert("Inserisci il nome dell'ospite."); return; }
            const guestName = capitalizeName(guestNameRaw);
            const checkInTime = checkInTimeInput.value;
            const checkOutTime = checkOutTimeInput.value;
            const bookingId = Date.now();

            const startDayBookings = bookings[startDate] || [];
            const endDayBookings = bookings[endDate] || [];

            if (startDayBookings.some(b => b.eventType === 'checkin')) { alert(`Conflitto: il giorno ${startDate} ha già un check-in.`); return; }
            if (endDayBookings.some(b => b.eventType === 'checkout')) { alert(`Conflitto: il giorno ${endDate} ha già un check-out.`); return; }
            const existingCheckout = startDayBookings.find(b => b.eventType === 'checkout');
            if (existingCheckout && checkInTime <= existingCheckout.time) { alert(`Conflitto orario: il check-in deve essere dopo le ${existingCheckout.time} del ${startDate}.`); return; }
            const existingCheckin = endDayBookings.find(b => b.eventType === 'checkin');
            if (existingCheckin && checkOutTime >= existingCheckin.time) { alert(`Conflitto orario: il check-out deve essere prima delle ${existingCheckin.time} del ${endDate}.`); return; }

            if (!bookings[startDate]) bookings[startDate] = [];
            bookings[startDate].push({ bookingId, eventType: 'checkin', guestName, time: checkInTime });

            if (startDate === endDate) {
                bookings[startDate].push({ bookingId, eventType: 'checkout', guestName, time: checkOutTime });
            } else {
                if (!bookings[endDate]) bookings[endDate] = [];
                bookings[endDate].push({ bookingId, eventType: 'checkout', guestName, time: checkOutTime });
            }
            
            saveBookingsToLocalStorage();
            updateCalendarUI();
            closeBookingModal();
        }
        
        function saveExistingBooking(bookingId, startDate, endDate) {
            const guestNameRaw = guestNameInput.value.trim();
            if (!guestNameRaw) { alert("Inserisci il nome dell'ospite."); return; }
            const guestName = capitalizeName(guestNameRaw);
            const checkInTime = checkInTimeInput.value;
            const checkOutTime = checkOutTimeInput.value;

            const startDayBookings = (bookings[startDate] || []).filter(b => b.bookingId !== bookingId);
            const endDayBookings = (bookings[endDate] || []).filter(b => b.bookingId !== bookingId);
            
            const existingCheckout = startDayBookings.find(b => b.eventType === 'checkout');
            if (existingCheckout && checkInTime <= existingCheckout.time) { alert(`Conflitto orario: il check-in deve essere dopo le ${existingCheckout.time} del ${startDate}.`); return; }
            const existingCheckin = endDayBookings.find(b => b.eventType === 'checkin');
            if (existingCheckin && checkOutTime >= existingCheckin.time) { alert(`Conflitto orario: il check-out deve essere prima delle ${existingCheckin.time} del ${endDate}.`); return; }

            const checkinEvent = (bookings[startDate] || []).find(b => b.bookingId === bookingId);
            if (checkinEvent) {
                checkinEvent.guestName = guestName;
                checkinEvent.time = checkInTime;
            }

            const checkoutEvent = (bookings[endDate] || []).find(b => b.bookingId === bookingId);
            if (checkoutEvent) {
                checkoutEvent.guestName = guestName;
                checkoutEvent.time = checkOutTime;
            }
            
            saveBookingsToLocalStorage();
            updateCalendarUI();
            closeBookingModal();
        }

        prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        cancelBtn.addEventListener('click', closeBookingModal);

        function handleSelectionStart(event) {
            if (event.type === 'touchstart') event.preventDefault();
            const target = event.type === 'touchstart' ? event.touches[0].target : event.target;
            const targetCell = target.closest('.day-cell');
            if (!targetCell || targetCell.classList.contains('intermediate-day')) return;
            
            isSelecting = true;
            selectionStartDate = targetCell.dataset.date;
            selectionEndDate = targetCell.dataset.date;
            updateSelectionPreview();
        }

        function handleSelectionMove(event) {
            if (!isSelecting) return;
            if (event.type === 'touchmove') event.preventDefault();
            let target;
            if (event.type === 'touchmove') {
                const touch = event.touches[0];
                target = document.elementFromPoint(touch.clientX, touch.clientY);
            } else {
                target = event.target;
            }
            const targetCell = target.closest('.day-cell');
            if (targetCell) {
                selectionEndDate = targetCell.dataset.date;
                updateSelectionPreview();
            }
        }

        function handleSelectionEnd() {
            if (!isSelecting) return;
            isSelecting = false;
            let start = selectionStartDate;
            let end = selectionEndDate;
            if (new Date(start) > new Date(end)) [start, end] = [end, start];
            
            let isConflict = false;
            let currentDate = new Date(Date.UTC(...start.split('-').map((n,i) => i === 1 ? n-1 : n)));
            let endDateObj = new Date(Date.UTC(...end.split('-').map((n,i) => i === 1 ? n-1 : n)));

            while(currentDate <= endDateObj) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const dayBookings = bookings[dateStr] || [];
                if (dateStr === start && dayBookings.some(b => b.eventType === 'checkin')) { isConflict = true; break; }
                if (dateStr === end && dayBookings.some(b => b.eventType === 'checkout')) { isConflict = true; break; }
                if (start !== dateStr && end !== dateStr && dayBookings.length > 0) { isConflict = true; break; }
                currentDate.setUTCDate(currentDate.getUTCDate() + 1);
            }
            
            clearSelectionPreview();
            if (isConflict) { alert("La selezione non può includere giorni già prenotati o sovrapporsi in modo non valido."); return; }
            openBookingModal(start, end);
        }

        calendarGridEl.addEventListener('mousedown', handleSelectionStart);
        calendarGridEl.addEventListener('mousemove', handleSelectionMove);
        window.addEventListener('mouseup', handleSelectionEnd);
        calendarGridEl.addEventListener('touchstart', handleSelectionStart, { passive: false });
        calendarGridEl.addEventListener('touchmove', handleSelectionMove, { passive: false });
        window.addEventListener('touchend', handleSelectionEnd);
        
        function handleDayClick(dateStr) {
            const cell = document.querySelector(`.day-cell[data-date="${dateStr}"]`);
            if (cell && cell.dataset.bookingIds) {
                try { 
                    const ids = JSON.parse(cell.dataset.bookingIds);
                    if (ids.length > 0) openDetailsModal(ids);
                } catch(e) { console.error("Could not parse booking ids", e); }
            }
        }

        function updateSelectionPreview() {
            clearSelectionPreview();
            if (!selectionStartDate || !selectionEndDate) return;
            let start = selectionStartDate;
            let end = selectionEndDate;
            if (new Date(start) > new Date(end)) [start, end] = [end, start];

            document.querySelectorAll('.day-cell').forEach(cell => {
                const date = cell.dataset.date;
                if (date >= start && date <= end) {
                    cell.classList.add('selection-preview');
                    if (start === end) cell.classList.add('line-single');
                    else if (date === start) cell.classList.add('line-start');
                    else if (date === end) cell.classList.add('line-end');
                    else cell.classList.add('line-middle');
                    
                    const connector = document.createElement('div');
                    connector.className = 'line-connector';
                    cell.appendChild(connector);
                }
            });
        }

        function clearSelectionPreview() {
            document.querySelectorAll('.day-cell').forEach(cell => {
                cell.classList.remove('selection-preview', 'line-start', 'line-middle', 'line-end', 'line-single');
                const existingConnector = cell.querySelector('.line-connector');
                if(existingConnector) existingConnector.remove();
            });
        }
        
        const guestDropdown = document.getElementById('guest-list-dropdown');
        const deleteSelectedBtn = document.getElementById('delete-selected-booking');

        guestDropdown.addEventListener('change', () => { deleteSelectedBtn.disabled = guestDropdown.value === ''; });

        deleteSelectedBtn.addEventListener('click', () => {
            const selectedBookingId = parseInt(guestDropdown.value, 10);
            if (!selectedBookingId) return;
            const bookingInfo = guestBookings.get(selectedBookingId);
            if (!bookingInfo) return;
            
            const onConfirmDelete = () => {
                for (const dateStr in bookings) {
                    bookings[dateStr] = bookings[dateStr].filter(b => b.bookingId !== selectedBookingId);
                    if (bookings[dateStr].length === 0) delete bookings[dateStr];
                }
                saveBookingsToLocalStorage();
                updateCalendarUI();
                guestDropdown.value = '';
                deleteSelectedBtn.disabled = true;
            };
            openConfirmModal(`Sei sicuro di voler eliminare la prenotazione per ${bookingInfo.guestName}?`, onConfirmDelete);
        });

        function initialize() {
            loadBookingsFromLocalStorage();
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }

        initialize();
    </script>
</body>
</html>
